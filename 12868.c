#include<reg51.h>
#define uchar unsigned char
#define uint  unsigned int

sbit rs=P2^7;
sbit rw=P2^6;
sbit en=P2^5;
sbit bee=P1^0;
sbit qd=P1^1;
sbit add=P2^3;
sbit sub=P2^2;
sbit DQ=P2^4;
sbit hwx=P3^2;
sbit power=P1^2;
sbit jr=P1^3;
sbit remwarning=P1^4;
bit yes=0;
bit gwarning=1;
/*************************定义变量*************/
uchar q=18;
uchar dispq[2];
uchar recv[4];
uchar tempreture[4];

/*************************字符*****************/
uchar code str1[]={"  中国矿业大学  "};
uchar code str2[]={"    徐海学院    "};
uchar code str3[]={"    毕业设计    "};
uchar code str4[]={"《家庭供暖控制器"};
uchar code str5[]={"    的设计》    "};
uchar code str6[]={"    李尚然      "};
uchar code gaow[]={"    高温警告    "};
uchar code loud[]={"    漏电警告    "};
uchar code sett[]={"设置的温度:"} ;
uchar code nowt[]={"当前的温度:"};
uchar code spa[]={"  "};
uchar code pic[]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xCC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x86,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x86,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x7B,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x06,0xFD,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x06,0xFD,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0xFC,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0xFC,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x18,0xFC,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x18,0xFC,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x30,0xFC,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x30,0xFC,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x60,0xFC,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x60,0xFC,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFC,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFC,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x80,0xFC,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x80,0xFC,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x03,0x00,0xFC,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x03,0x00,0xFC,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x78,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x78,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x78,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x78,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x78,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x78,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x78,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x78,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x30,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x30,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x30,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x78,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x78,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x30,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

/*************************延时*****************/
void delay140us(uchar x)
{
	unsigned char k;
	while(x--)
	{
		for(k=0;k<13;k++){}
	}
}
void delay(uchar i)	        //40*i us
{
	unsigned char j,k;
	for(j=0;j<i;j++)
		for(k=0;k<10;k++);
}
void delayms(uint i)        //延时子程序
{
   uint x,y;
   for(x=0;x<i;x++)
   	for(y=0;y<121;y++);
}

/***********************判忙******************/
/*void busy()
{
	rs=0;
	rw=1;
	en=1;
	while(P0&0x80==0x80);
	en=0;
}*/
/****************写指令*************************/
void wcmd(uchar com)
{
//	busy();
	rs=0;
	rw=0;
	en=1;
	P0=com;
	delay(10);
	en=0;
}

/***********************写数据*********************/
void wdat(uchar dat)
{
//	busy();
	rs=1;
	rw=0;
	en=1;
	P0=dat;
	delay(10);
	en=0;
}
/**********************初始化LCD**********************/
void init()
{
	delay(5);
	wcmd(0x30);
	delay(5);
	wcmd(0x0c);
	delay(5);
	wcmd(0x01);
	delay(5);
	wcmd(0x06);
	delay(5);
}

/*****************************写LOG**************************/
void wLog()
{
	uchar i;
	delay(10);
	wcmd(0x80);		      //第一页显示
	for(i=0;i<16;i++)
	{
		wdat(str1[i]);
		delay(10);
	}
	wcmd(0x90);
	delay(10);
	for(i=0;i<16;i++)
	{
		wdat(str2[i]);
		delay(10);
	}					  
	wcmd(0x88);
	for(i=0;i<16;i++)
	{
		wdat(str3[i]);
		delay(10);
	}                       

	delayms(5000);	    //第二页显示
	wcmd(0x01);
	delayms(3);
	wcmd(0x80);
	delay(5);
	for(i=0;i<16;i++)
	{
		wdat(str4[i]);
		delay(5);
	}
	wcmd(0x90);
	delay(5);
	for(i=0;i<16;i++)
	{
		wdat(str5[i]);
		delay(5);
	}
	wcmd(0x88);
	delay(5);
	for(i=0;i<16;i++)
	{
		wdat(str6[i]);
		delay(5);
	}
	delayms(5000);
	wcmd(0x01);
	delayms(3);
}
/***************************绘图********************************/
void draw(uchar code *p)
{
	uchar i,j;
	delay(2);
	wcmd(0x34);			  //绘图显示关
	for(i=0;i<32;i++)
	{
		delay(5);
		wcmd(0x80+i);
		delay(5);
		wcmd(0x80);
		delay(2);
		for(j=0;j<16;j++)
		{
		//	delay(5);			
			wdat(*p++);
		}
	}
	for(i=0;i<32;i++)
	{
		wcmd(0x80+i);
		wcmd(0x88);
		for(j=0;j<16;j++)
		{
		//	delay(3);
			wdat(*p++);
		}
	}
	delay(3);
	wcmd(0x36);				//绘图显示开
	delay(3);
	wcmd(0x30);			   //基本指令集开
}

/**************************高温报警*****************************/
void warning()
{
	uchar i;
	wcmd(0x01);
	delay(15);
	power=0;				  //切断电源
	while(gwarning)
	{
		draw(pic);			  //载入图片
//		delay(5);
		wcmd(0x98);			  //写字符
		for(i=0;i<16;i++)
		{
			wdat(gaow[i]);	
		}
		bee=0;				  //开蜂鸣器
		delayms(500);
		bee=1;				   //500ms后关蜂鸣器，清屏
		wcmd(0x01);
		delayms(300);
		if(remwarning==0)
		{
			gwarning=0;
		}
	}
}

/**************************显示设置的字符************************/
void wsett()
{
	uchar i;
//	delay(3);
	wcmd(0x80);				      //设置显示字符的位置
	for(i=0;i<11;i++)			  //显示字符
	{
//		delay(3);
		wdat(sett[i]);	
	}
//	delay(3);					 //显示温度符号
	wcmd(0x96);
	delay(3);
	wdat(0xA1);
	wdat(0xE6);
//	delay(3);					  //显示温度符号
	wcmd(0x9F);					  //设置显示“℃”位置
	delay(3);
	wdat(0xA1);					  //显示“℃”
	wdat(0xE6);
//	delay(3);					 //显示当前温度字符
	wcmd(0x88);
	for(i=0;i<11;i++)
	{
	//	delay(3);
		wdat(nowt[i]);
	}
}

/*****************************显示设置温度*********************/
void dispset()
{
	uchar i;
	dispq[0]=q/10;
	dispq[1]=q%10;
//	delay(3);
	wcmd(0x95);					 //设置显示温度的位置
	for(i=0;i<2;i++)			 //显示设置的温度
	{								 
//		delay(3);
		wdat(dispq[i]+0x30);
	}
}
/*****************************写空字符***************************/
void space()
{
	uchar i;
//	delay(3);
	wcmd(0x95);					 //设置显示温度的位置
	for(i=0;i<2;i++)			 //显示设置的温度
	{								 
		//delay(3);
		wdat(spa[i]);
	}
}
/****************************红外接收控制**********************/
void chwx()
{
	hwx=1;
	EX0=1;
	EA=1;
	IT0=1;
}

/*****************************红外接收**************************/
void Irecv() interrupt 0
{
	uchar i,j,c=0;
	
	EX0=0;		           //关中断
							
	while(hwx)	          //确认红外信号是否出现
	{
		EX0=1;
		return;
	}
	while(!hwx)		    	//跳过9ms的前导低电平
	{
		delay140us(1);	
	} 
	for(i=0;i<4;i++)       //收集4组数据
	{
		for(j=0;j<8;j++)	//每组8个
		{
			while(hwx)		     //跳过4.5ms的前导高电平
			{
				delay140us(1);
			} 
			while(!hwx)		      //等信号变为高
			{
				delay140us(1);
			}
			while(hwx)	        //计算高电平的时长
			{
				delay140us(1);
				c++;
				if(c>=30)
				{
					EX0=1;
					return;
				}
			}						 //高电平计算完毕
			recv[i]=recv[i]>>1;		 //高位补“0”
			if(c>=8)			 	 //如果高电平时长大于1ms，则判定为“1”，高位补“1”
			{
				recv[i]=recv[i]|0x80;
			}
			c=0;
		}	                         //收集完8位数据
	}								 //收集完4组数据
	if(recv[2]!=~recv[3])			 //检查接收的信号是否正确
	{
		EX0=1;
		return;
	}
	yes=0;
	switch(recv[2])			          ////控制占空比
	{
			case 0x07:q--;break;	  //占空比-
			case 0x15:q++;break;	  //占空比+
			case 0x40:yes=1;break;
			case 0x44:gwarning=0;break;
	}
	EX0=1;
}

/********************设定温度**************************/
void settemperature()
{
	if(add==0)		     //温度+
	{
		yes=0;
		delayms(50);
		q++; 
	}

	if(sub==0)			//温度-
	{
		yes=0;
		delayms(50);
		q--;
	}					
}
/********************上电时设置温度********************/
void powersett()
{
	if(add==0)		     //温度+
	{
		delayms(50);
		q++; 
	}

	if(sub==0)			//温度-
	{
		delayms(50);
		q--;
	}	
}
/*********************DS18B20复位**********************/
void reset()
{
	uchar i;
	bit flag=1;
	while(flag)
	{
		DQ=0;
		for(i=0;i<160;i++);	//延时500us
		DQ=1;				//释放总线
		for(i=0;i<26;i++);  //延时80us
		flag=DQ;
		for(i=0;i<80;i++);	//延时60~240us
	}
}

/*********************写数据到DS18B20********************/
void w18b20(uchar wdata)
{
	uchar i,j;
	for(i=0;i<8;i++)
	{
		DQ=0;			   //拉低总线，产生写时序
		for(j=0;j<1;j++);  //延时4us发送一位
		DQ=wdata&0x01;
		for(j=0;j<20;j++);  //写数据至少要延时60us
		DQ=1;
		wdata>>=1;
	}
}

/********************读DS18B20数据********************/
uchar r18b20()
{
	uchar i,j,rdata;
	for(j=0;j<8;j++)
	{
		DQ=0;
		rdata>>=1;				//拉低总线，产生读时序
		for(i=0;i<1;i++);	//延时4us
		DQ=1;				//释放总线，准备读数据
		for(i=0;i<2;i++);	//延时8us，读数据
		if(DQ) 
		rdata|=0x80;
		for(i=0;i<20;i++);
	}
	return(rdata);
}

/**************************得到十进制温度********************/
uint gettemp()
{
	uchar i,l,h;
	uint t;
	float tt;
	bit flag=0;
	reset();
	w18b20(0xcc);
	w18b20(0x44);
	while(!flag)
	{
		DQ=0;
		for(i=0;i<1;i++);
		DQ=1;
		for(i=0;i<2;i++);
		flag=DQ;
		for(i=0;i<20;i++);
	}
	reset();
	w18b20(0xcc);
	w18b20(0xbe);
	l=r18b20();
	h=r18b20();
	t=h;
	t<<=8;
	t=t|l;
	tt=t*0.0625;
	t=tt*100+0.5;
	return(t);
}

/*************************温度的显示********************/
void dist() 
{
	uchar i;
	uint temp;
	temp=gettemp();
	tempreture[0]=temp/1000;
	tempreture[1]=temp%1000/100;
	tempreture[2]=temp%100/10;
	tempreture[3]=temp%10;
//	delay(3);
	wcmd(0x9C);					   //温度显示位置
	delay(3);
	wdat(0x20);					   //显示“空格”，为了让显示的数据更紧凑
	for(i=0;i<2;i++)			   //显示当前温度
	{
//		delay(3);
		wdat(tempreture[i]+0x30);
	}
	wdat(0x2E);					   //显示“.”
//	delay(3);
	wdat(tempreture[2]+0x30);
//	delay(5);
	wdat(tempreture[3]+0x30);
	
}

/***************************温度比较****************************/
void comparet()
{
	uint num;
	uchar shi,ge,nowtemp;
	num=gettemp();
	shi=num/1000;
	ge=num%1000/100;
	nowtemp=shi*10+ge;
	if(q>nowtemp&q-nowtemp>1)
	{
		jr=0;			  //相差1℃以上，满占空比，开始加热
	}
	if(q-nowtemp<=1)
	{
		jr=1;			 //相差1℃以内，占空比为0，停止加热
	}
}

/**************************检测高温信号**************************/
void chackht()
{
	uint num;
	uchar shi,ge,nowtemp;
	
	num=gettemp();
	shi=num/1000;
	ge=num%1000/100;
	nowtemp=shi*10+ge;
	if(nowtemp>q&nowtemp-q>=5)
	{
		gwarning=1;
		warning();
		wsett();		 	   	 //显示设定的字符
		power=1;
	}	
}
/****************************主函数*****************************/
void main()
{
	init();			 		 //液晶屏初始化
//	wLog();					 //写Log
	bee=1;					 //初始化蜂鸣器
	power=1;				 //初始化电源	 
	wsett();		 	   	 //显示设定的字符	
	chwx();					 //启动红外控制
	while(1)
	{
		jr=1;				 //占空比为0，停止加热
		dispset();	         //显示设定的温度
		dist();	        	 //显示检测的温度
		powersett();	     //上电时设定温度
		delayms(200);
		space();
		delayms(300);
		
		if(qd==0)			 //等待确定按键
		{
			yes=1;
			gwarning=1;
		}

		while(yes&gwarning)
		{
			dispset();	         //显示设定的温度
			dist();	        	 //显示检测的温度
			settemperature();	 //设定温度
			comparet();	         //温度比较
			chackht();        	 //检测高温信号
		}		
	}
}